# 项目介绍

---

该项目首先是一个网络聊天服务器的项目，项目在单机模式下主要有以下结果模块，分别是网络层、服务层、数据存储层、

1. 网络模块采用的是muduo库、性能非常强的开源的网络库来进行设计的，使用开源网络库的好处就是解耦了网络模块代码与业务模块代码，可以更加专注于业务模块的开发。
2. 在服务层业务逻辑处理实现方面，使用了map + bind绑定器实现了一个消息id、与消息发生之后对应业务逻辑操作的绑定，相当于实现了一个回调机制，当网络IO检测到一个消息请求时，从该请求消息中解析json数据、得到一个消息id、根据消息id去调用相应的业务处理方法。
3. 在数据存储层使用了mysql来存储项目上的一些关键的数据，比如用户的账号、好友的列表、群组的列表关系、离线的消息、这些信息都是在mysql中进行存储
4. 单机服务下主要就是以上的几个模块，由于在单机服务下系统的并发能力是有限的，所以为了提升系统的并发能力，将项目做了一个多机的扩展，通过将系统部署在多台服务器上，并利用nginx负载均衡进行客户端请求的分发，来提升系统的并发量。本项目主要是基于tcp长连接私有协议搭建的cs架构的通信系统，所以负载均衡时也需要做基于tcp长连接，
5. 由于消息聊天通信，客户端不仅仅需要向服务器主动发送消息，服务器也需要主动向客户端推送消息，这就决定了系统必须使用tcp的长连接，采用短连接则服务器无法向客户端推送消息，
6. 考虑到在多机部署之后，不同聊天服务器上登录的用户之间也需要通信， 所以引入了redis作为mq消息队列的功能，利用redis的发布订阅功能实现了跨服务器的消息通信功能，

主要技术点：

1. 使用muduo网络库作为项目的网络核心模块，提供高并发网络IO服务，解耦网络和业务模块的代码

    （muduo网络库是基于reactor模型的高性能开源网络库、网络模块代码不需要手写，只需要在onMessage中编写相应的业务处理逻辑即可）

2. 使用Json序列化与反序列化消息作为私有通信

3. 配置nginx基于tcp的负载均衡，实现聊天服务器的集群功能、提高后端服务的并发能力

4. 基于发布订阅模式的服务器中间件redis作为消息队列，实现了跨服务器的消息通信

5. 使用Mysql关系型数据库作为系统数据的核心存储

6. 网络IO模块、业务模块、数据模块分层设计

7. 使用数据库连接池有效的提高了数据库的数据存取性能，

数据库的优化：

一般来说单体服务的性能瓶颈都是出现数据库，因为数据库属于磁盘IO，如何快速提高数据库的性能？

1. 利用mysql的主从复制，进行读写分离，
2. 因为大部分的数据库操作都是修改的少，而查询的多，
3. 可以进行mysql的多机部署，只使用一台机器进行修改操作，使用多太机器进行查询读取操作，
4. 写机器的mysql与多个读机器的mysql之间通过binlog二进制日志进行数据同步，

压力测试：通过代码脚本或专业的压测工具Jmeter测试服务器的并发量，通过设置进程可使用fd资源上限数量，提高并发能力。

- linux每一个进程所能够使用的fd是有上限的，刚开始压力测试只有几千
- 对于8G内存、4核的CPU对于并发的连接量，单机的上限是可以到达两万的，每次连接一个客户端服务端都要分配一个socketfd，来专门与客户端进行网络通信（并发连接量的上限与服务端进程所能够使用的fd资源上限是有紧密关系的），可以通过调整设置服务端进程所能够使用的fd数量来提高系统的并发性能，

收获：熟悉了基于开源网络库进行服务端程序的设计，掌握了nginx的负载均衡配置、学习了存储和服务器中间件的应用，

项目中遇到的问题：



